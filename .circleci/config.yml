version: 2.1

orbs:
  win: circleci/windows@2.2.0

parameters:
  tag_no1:
    type: string
    default: "1.26.1"
  tag_no2:
    type: string
    default: None
  command_to_execute:
    type: string
    default: "pip3 install requests & pip3 install psutil & pip3 install sqlite-utils>=2.18 & sqlite-utils --version"

executors:
  linux:
    machine:
      image: ubuntu-2004:202010-01
    resource_class: xlarge
  macos:
    macos:
      xcode: 11.3.0
#      resource_class: large
  windows: win/default
#    size: "xlarge" # resource class, can be "medium", "large", "xlarge", "2xlarge", defaults to "medium" if not specified

jobs:
  sync_test:
    parameters:
      os:
        type: string
      env:
        type: string
    executor: << parameters.os >>
    working_directory: ~/repo
    steps:
      - when:
          condition: <<parameters.is_unix_based>>
          steps:
            name: "Run for unix based"
            command: |
              << pipeline.parameters.command_to_execute >>
      - unless:
          steps:
            name: "Run for windows"
            command: |
              << pipeline.parameters.command_to_execute >>
          shell: bash.exe
      - run:
          name: run sync test
          no_output_timeout: 120m
          command: |
            echo $PWD
            echo $env
            echo $HOME
            echo $working_directory
            ls -d */
            python3 ./sync_tests/sync_test2.py -t1 << pipeline.parameters.tag_no1 >> -t2 << pipeline.parameters.tag_no2 >> -e << parameters.env >>
      - store_artifacts:
          path: ./sync_tests/logfile.log
          destination: node_logs

workflows:
  build:
    jobs:
      - sync_test:
          matrix:
            parameters:
              os: [ linux, macos, windows ]
#              env: [shelley_qa, testnet, staging, mainnet]
              env: [shelley_qa]
              is_unix_based: [ true, true, false]
          name: test-on-<< matrix.os >>-with-env-<< matrix.env >>
#          post-steps: # steps to run after steps defined in the job bar
#            - run:
#                command: echo "upload artifact to s3"
